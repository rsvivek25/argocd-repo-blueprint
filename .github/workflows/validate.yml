name: Validate Manifests

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**.yaml'
      - '**.yml'
      - 'charts/**'
      - 'environments/**'
      - 'platform/**'
      - 'argocd/**'

jobs:
  validate-yaml:
    name: YAML Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: |
          yamllint -c .yamllint.yml .

  validate-helm:
    name: Helm Chart Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: Lint Helm charts
        run: |
          helm lint charts/workload

      - name: Template Helm charts for cldev01
        run: |
          helm template app1 charts/workload \
            -f environments/cldev01/values/app1-values.yaml \
            --namespace cldev01 > /tmp/app1-cldev01.yaml
          
          helm template app2 charts/workload \
            -f environments/cldev01/values/app2-values.yaml \
            --namespace cldev01 > /tmp/app2-cldev01.yaml

      - name: Template Helm charts for clat01
        run: |
          helm template app1 charts/workload \
            -f environments/clat01/values/app1-values.yaml \
            --namespace clat01 > /tmp/app1-clat01.yaml

  validate-kubernetes:
    name: Kubernetes Manifest Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Install kubeconform
        run: |
          wget https://github.com/yannh/kubeconform/releases/download/v0.6.3/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate Kubernetes manifests
        run: |
          # Validate platform manifests
          kubeconform -strict -summary \
            platform/storage/*.yaml \
            platform/node-pools/*.yaml \
            platform/cluster-config/*.yaml
          
          # Validate ArgoCD applications
          kubeconform -strict -summary \
            argocd/*.yaml \
            argocd/workload-apps/*.yaml

      - name: Validate environment manifests
        run: |
          kubeconform -strict -summary \
            environments/cldev01/*.yaml \
            environments/cldev02/*.yaml \
            environments/clat01/*.yaml

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  policy-check:
    name: Policy Compliance (OPA)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/v0.57.0/opa_linux_amd64_static
          chmod 755 ./opa
          sudo mv opa /usr/local/bin/

      - name: Check resource limits policy
        run: |
          echo "Validating that all deployments have resource limits defined..."
          # Add custom OPA policies here

  pr-comment:
    name: PR Comment Summary
    runs-on: ubuntu-latest
    needs: [validate-yaml, validate-helm, validate-kubernetes]
    if: always()
    steps:
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Validation checks completed. Review the workflow results above.'
            })
